letsencrypt:
  image: jrcs/letsencrypt-nginx-proxy-companion
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./certificates:/etc/nginx/certs:rw
  volumes_from:
    - nginx

nginx:
  image: jwilder/nginx-proxy
  volumes:
    - /var/run/docker.sock:/tmp/docker.sock:ro
    - ./certificates:/etc/nginx/certs:ro
    - ./nginx/vhost.d:/etc/nginx/vhost.d
    - ./nginx/html:/usr/share/nginx/html
  ports:
    - 80:80
    - 443:443
  links:
    - app

db:
  image: postgres
  volumes:
    - /container-data/mattermost/dumps:/dumps
    - /container-data/mattermost/pgdata:/pgdata
  environment:
   - POSTGRES_USER=mmuser
   - POSTGRES_PASSWORD=mmuser_password
   - POSTGRES_DB=mattermost
   - PGDATA=/pgdata

app:
  build: app
  links:
    - db:db
  volumes:
    - ./volumes/app/mattermost/config:/mattermost/config:rw
    - ./volumes/app/mattermost/data:/mattermost/data:rw
    - /etc/localtime:/etc/localtime:ro
  ports:
    - "3000:80"
  environment:
    VIRTUAL_HOST: chat.enspiral.com
    LETSENCRYPT_HOST: chat.enspiral.com
    LETSENCRYPT_EMAIL: rob@loomio.org

matterbridge:
  build: matterbridge
  volumes:
    - ./matterbridge.conf:/matterbridge.conf
